<html lang="en">
<script src="//code.jquery.com/jquery-1.9.1.js"></script>
<script src="//code.jquery.com/ui/1.10.4/jquery-ui.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/timepicker/1.3.5/jquery.timepicker.min.js"></script>
<link rel="stylesheet" href="http://jqueryui.com/resources/demos/style.css">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/timepicker/1.3.5/jquery.timepicker.min.css">
<link rel="stylesheet" href="//code.jquery.com/ui/1.10.4/themes/smoothness/jquery-ui.css">
<!-- <link rel="stylesheet" href="https://allthing-can.com/wp-content/plugins/ca-booking-system/html/style.css"> -->

<head>
<style>
table, tr, td {
    border: 1px solid black;
    text-align: center;
}
    
caption {
    text-align: center;
}
    
.btn-pop {
    background-color: #ffd475;  
    border-radius: 10px;
    border:0px;
    zoom:200%;
}
            
#background-pop{
    display: none;
    position: fixed;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
}
           
#div-pop{
    background:#ffffff;
    width:30%;
    z-index: 1;
    margin: 12% auto;
    overflow: auto;
}
            
.div-top{
    width: 100%;
    height: auto;
    background-color: #28a3e7;
    color: #ffffff;
}
            
.div-top div {
    padding: 3px 5px 5px 8px;
}
            
span {
    color: white;
    margin-bottom: 10px ;
    margin-left: 20px ;
    cursor: pointer;
    float: right;
}
           
.div-content {
    width: auto;
    height: 200px;
    overflow: auto;
}
            
.div-footer {
    text-align: center;
    background-color: darkgray;
}
    
.selected_button {
    background-color: white;
    border: solid;
    color: black;
}
</style>
</head>

<body>
    <!-- Switch to different table mode -->
    <div>
        <button class="selected_button" style="width: 200px;" id="button_1on1" onclick="changeTableMode(1)">1on1</button>
        <button style="width: 200px;" id="button_group" onclick="changeTableMode(2)">group</button>
        <button style="width: 200px;" id="button_history" onclick="changeTableMode(3)">Booking History</button>
    </div>

    <!-- Personal Info -->
    <dl>
        <dt id="user_name_field">Username: </dt>
        <dt id="user_role_field">Role: </dt>
        <dt id="user_email_field">Email: </dt>
        <dt id="timezone_field">Location: </dt>
        
        <!-- UTC -->
        <dt id="local_utc_field">UTC:
            <select id="UTC_Timezone" onchange="utcChangeEvent()">
                <option>UTC-12</option>
                <option>UTC-11</option>
                <option>UTC-10</option>
                <option>UTC-9</option>
                <option>UTC-8</option>
                <option>UTC-7</option>
                <option>UTC-6</option>
                <option>UTC-5</option>
                <option>UTC-4</option>
                <option>UTC-3</option>
                <option>UTC-2</option>
                <option>UTC-1</option>
                <option>UTC+0</option>
                <option>UTC+1</option>
                <option>UTC+2</option>
                <option>UTC+3</option>
                <option>UTC+4</option>
                <option>UTC+5</option>
                <option>UTC+6</option>
                <option>UTC+7</option>
                <option>UTC+8</option>
                <option>UTC+9</option>
                <option>UTC+10</option>
                <option>UTC+11</option>
                <option>UTC+12</option>
                <option>UTC+13</option>
                <option>UTC+14</option>
            </select>
        </dt>
    </dl>

    <!-- Booking history table -->
    <div style="display: none" id="student_book_history_info">
        <div>
            <label>查看預約的課程種類:</label>
            <button class="selected_button" style="width: 200px;" id="student_book_histroy_button_1on1" onclick="bookHistoryMode(1)">1on1</button>
            <button style="width: 200px;" id="student_book_histroy_button_group" onclick="bookHistoryMode(2)">group</button>        
        </div>
        <table id="student_book_history_table">
            <tr>
                <td>課程名稱</td>
                <td>課程時間</td>
                <td>授課老師</td>
            </tr>
            <tr>
                <td id="book_history_course_name_container"></td>
                <td id="book_history_course_time_container"></td>
                <td id="book_history_course_teacher_container"></td>
            </tr>
        </table>
    </div>

    <!-- Teacher open course history table -->
    <div style="display: none" id="teacher_open_history_info">
        <table id="teacher_open_history_table">
            <tr>
                <td>課程名稱</td>
                <td>課程時間</td>
                <td>學生人數</td>
                <td>編輯</td>
            </tr>
            <tr>
                <td id="teacher_open_history_course_name_container"></td>
                <td id="teacher_open_history_course_time_container"></td>
                <td id="teacher_open_history_course_student_container"></td>
                <td id="teacher_open_history_edit_button_container"></td>
            </tr>
        </table>
    </div>

    <div id="course_info_fields">
    <!-- Teacher Checkboxs -->
    <div id="checkbox_container">
    </div>
    
    <!-- Change date button -->
    <div style="display: flex; justify-content: space-between;">
        <button onclick="prevDateEvent()">PREV</button>
        <button onclick="goBackTodayEvent()">Go Back To Today</button>
        <button onclick="nextDateEvent()">NEXT</button>
    </div>
    
    <!-- Weekly calendar -->
    <table>
        <caption id="current_month"><h3></h3></caption>
        <tr>
            <td>Mon</td>
            <td>Tue</td>
            <td>Wed</td>
            <td>Thu</td>
            <td>Fri</td>
            <td style="color: red">Sat</td>
            <td style="color: red">Sun</td>
        </tr>
        <tr>
            <td id="current_mon"></td>
            <td id="current_tue"></td>
            <td id="current_wed"></td>
            <td id="current_thu"></td>
            <td id="current_fri"></td>
            <td id="current_sat" style="color: red"></td>
            <td id="current_sun" style="color: red"></td>
        </tr>
        <tr>
            <td id="current_mon_container"></td>
            <td id="current_tue_container"></td>
            <td id="current_wed_container"></td>
            <td id="current_thu_container"></td>
            <td id="current_fri_container"></td>
            <td id="current_sat_container"></td>
            <td id="current_sun_container"></td>
        </tr>
    </table>

    <!-- Teacher can set the course info -->
    <div style="display: none" id="teacher_course_settings">
    <dl>
        <dt>
            <p>Teacher:<input type="text" id="tname" name="tname"></p>
        </dt>
        <dt>
            <p>Date:<input type="text" class="datepicker" id="datepicker"></p>
        </dt>
        <dt>
            <p>Start Time:<input type="text" class="timepicker" id="course_start_time"></p>
        </dt>
        <dt>
            <p>End Time:<input type="text" class="timepicker" id="course_end_time"></p>
        </dt>
        <dt style="display: none" id="student_max_num_field">
            <p>Student Max Number:<input type="text" id="student_max_num"></p>
        </dt>
        <dt>
            <p>Price:<input type="text" id="course_price"></p>
        </dt>
    </dl>
        <button style="float: right;" onclick="add_new_course()">CREATE</button>
    </div>
    </div>

    <!-- Pop booking window -->
    <div id="background-pop">
        <div id="div-pop">
            <div class="div-top">
                <span id="close-button">[X]</span>
                <div>Check your user information...</div>
            </div>
            <div class="div-content">
                <p>Username:<input type="text" id="pay_user_name"></p>
                <p>Email:<input type="text" id="pay_user_email"></p>
            
                <!-- Auto generate PayPal button -->
                <!-- TODO action URL need to switch with admin backend settings -->
                <div style='margin-left: auto;margin-right: auto;width:170px'>
                    <form action='https://www.sandbox.paypal.com/cgi-bin/webscr' method='post'>
                        <input type='hidden' name='cmd' value='_xclick' />
                        <input type='hidden' name='business' value='sb-3lpsb8564015@business.example.com' />
                        <input type='hidden' id='ca_booking_name' name='item_name' value='THIS_IS_A_COURSE_WITH_DATETIEM!!!!' />
                        <input type='hidden' name='currency_code' value='USD' />
                        <input type='hidden' id='ca_booking_value' name='amount' value='0.99' />
                        <input type='hidden' name='lc' value='EN_US'>
                        <input type='hidden' name='no_note' value=''>
                        <input type='hidden' name='paymentaction' value='sale'>
                        <input type='hidden' name='return' value='' />
                        <input type='hidden' name='bn' value='WPPlugin_SP'>
                        <input type='hidden' name='cancel_return' value='' />
                        <input type="hidden" id='ca_booking_username' name="custom" value="mycustomvalue">
                        <input style='border: none;' class='paypalbuttonimage' type='image' 
                            src='https://www.paypalobjects.com/webstatic/en_US/i/buttons/buy-logo-medium.png' border='0' name='submit'
                            alt='Make your payments with PayPal. It is free, secure, effective.'>
                        <img alt='' border='0' style='border:none;display:none;' src='https://www.paypal.com/EN_US/i/scr/pixel.gif' width='1' height='1'>
                    </form>
                </div>

            </div>
        </div>
    </div>
</body>


<script>
    // Settings
    let booking_data_1on1;
    let booking_keys_1on1;
    let booking_data_group;
    let booking_keys_group;
    var current_utc;
    var table_mode = 1;
    var teacher_names;

    const _months = [
        'January',
        'February',
        'March',
        'April',
        'May',
        'June',
        'July',
        'August',
        'September',
        'October',
        'November',
        'December'
    ];
    const _weekdays = [
        'Sunday',
        'Monday',
        'Tuesday',
        'Wednesday',
        'Thrusday',
        'Friday',
        'Saturday',
    ];
    const _offset2UTC = {
        "0": "UTC+0",
        "60": "UTC-1",
        "120": "UTC-2",
        "180": "UTC-3",
        "240": "UTC-4",
        "300": "UTC-5",
        "360": "UTC-6",
        "420": "UTC-7",
        "480": "UTC-8",
        "540": "UTC-9",
        "600": "UTC-10",
        "660": "UTC-11",
        "720": "UTC-12",
        "-60": "UTC+1",
        "-120": "UTC+2",
        "-180": "UTC+3",
        "-240": "UTC+4",
        "-300": "UTC+5",
        "-360": "UTC+6",
        "-420": "UTC+7",
        "-480": "UTC+8",
        "-540": "UTC+9",
        "-600": "UTC+10",
        "-660": "UTC+11",
        "-720": "UTC+12",
        "-780": "UTC+13",
        "-840": "UTC+14",
    };

    const teacher_open_course_colors = [
        "#ff8c00",
        "#9932cc",
        "#8b0000",
        "#9400d3",
        "#00ced1",
        "#696969"
    ];

    // Initialize the today date and move it to monday
    var _date = new Date();

    // AJAX
    function Init() {
        alert(ca_process_url)
        $.ajax({
            type: "POST",
            url: ca_process_url,
            data: {
                "type": "init",
            },
            dataType: "json",
            success: function (init_data) {
                remove_all_display_booking_data();
                
                // Date set to monday (the start point of a new week)
                _date = new Date();
                if (_date.getDay() == 0) _date.setDate(_date.getDate() - 6);
                else _date.setDate(_date.getDate()-_date.getDay()+1);

                document.getElementById("user_name_field").innerHTML = "Username: " + init_data.current_user_name;
                document.getElementById("user_role_field").innerHTML = "Role: " + init_data.current_user_role;
                document.getElementById("user_email_field").innerHTML = "Email: " + init_data.current_user_email;

                checkbox_init(init_data.teachers);
                teacher_names = init_data.teachers;
                alert(teacher_names);

                // If user role is teacher, he/she can add the new course on the booking system
                if (init_data.current_user_role == "um_teacher") {
                    document.getElementById("teacher_course_settings").style.display = "block";
                    document.getElementById("tname").value = init_data.current_user_name;
                    document.getElementById("tname").disabled = true;
                }
                    
                // Hide the student max num field
                document.getElementById("student_max_num_field").style.display = "none";

                booking_data_1on1 = convertBookingDataUTC(init_data.booking_data_1on1);
                booking_keys_1on1 = init_data.booking_keys_1on1;
                booking_data_group = convertBookingDataUTC(init_data.booking_data_group);
                booking_keys_group = init_data.booking_keys_group;

                setWeekDate(1);
                current_utc = document.getElementById("UTC_Timezone").value;

                // Book history
                bookHistoryMode(1);

                // Open course history
                openHistory();
            },
            error: function (xhr, s, error) {
                alert(xhr.status);
                alert(xhr.readyState);
                alert(xhr.responseText);
                alert(xhr.statusText);
            },
        });
    }

    function Add_New_Course_1on1(tname, _date, start_time, end_time, price) {
        var selected_utc = document.getElementById("UTC_Timezone").value;
        var utc_offset = -1 * parseInt(selected_utc.split("UTC")[1]);
        var start_time_timestamps = start_time.getTime();
        var end_time_timestamps = end_time.getTime();

        start_time.setTime(start_time_timestamps + utc_offset * 1000 * 60 * 60);
        end_time.setTime(end_time_timestamps + utc_offset * 1000 * 60 * 60);
        
        // Time
        var _st = start_time.getHours().toString() + ":" + start_time.getMinutes().toString();
        var _et = end_time.getHours().toString() + ":" + end_time.getMinutes().toString();

        $.ajax({
            type: "POST",
            url: ca_process_url,
            data: {
                "type": "add_new_course_1on1",
                "teacher_name": tname,
                "date": _date,
                "start_time": _st,
                "end_time": _et,
                "price": price,
            },
            dataType: "json",
            success: function(results) {
                alert(results.message);
            },
            error: function (xhr, s, error) {
                alert(xhr.status);
                alert(xhr.readyState);
                alert(xhr.responseText);
                alert(xhr.statusText);
            },
        });
    }

    function Add_New_Course_Group(tname, _date, start_time, end_time, student_max_num, price) {
        var selected_utc = document.getElementById("UTC_Timezone").value;
        var utc_offset = -1 * parseInt(selected_utc.split("UTC")[1]);
        var start_time_timestamps = start_time.getTime();
        var end_time_timestamps = end_time.getTime();

        start_time.setTime(start_time_timestamps + utc_offset * 1000 * 60 * 60);
        end_time.setTime(end_time_timestamps + utc_offset * 1000 * 60 * 60);
        
        // Time
        var _st = start_time.getHours().toString() + ":" + start_time.getMinutes().toString();
        var _et = end_time.getHours().toString() + ":" + end_time.getMinutes().toString();

        $.ajax({
            type: "POST",
            url: ca_process_url,
            data: {
                "type": "add_new_course_group",
                "teacher_name": tname,
                "date": _date,
                "start_time": _st,
                "end_time": _et,
                "student_max_num": student_max_num,
                "price": price,
            },
            dataType: "json",
            success: function(results) {
                alert(results.message);
            },
            error: function (xhr, s, error) {
                alert(xhr.status);
                alert(xhr.readyState);
                alert(xhr.responseText);
                alert(xhr.statusText);
            },
        });
    }

    function Before_Booking_Check_1on1(book_course_key, book_value, book_user_name, book_user_email) {
        // var book_course_key = book_course_key;
        // var book_user_name = book_user_name;
        // var book_user_email = book_user_email;

        $.ajax({
            type: "POST",
            url: ca_process_url,
            data: {
                "type": "before_booking_check_1on1",
                "book_course_key": book_course_key,
                "book_user_name": book_user_name,
                "book_user_email": book_user_email,
            },
            dataType: "json",
            success: function (check_results) {
                if (check_results.results == "ok") {
                    payEvent(book_course_key, book_value);
                }
                else if (check_results.results == "wait for payment") {
                    payEvent(book_course_key, book_value);
                }
                else if (check_results.results == "not you") {
                    alert("The course is booked by other people!");
                }
                else {
                    alert("The course is booked.");
                }
            },
            error: function (xhr, s, error) {
                alert(xhr.status);
                alert(xhr.readyState);
                alert(xhr.responseText);
                alert(xhr.statusText);
            },
        });
    }

    function Before_Booking_Check_Group(book_course_key, book_value, book_user_name, book_user_email) {
        $.ajax({
            type: "POST",
            url: ca_process_url,
            data: {
                "type": "before_booking_check_group",
                "book_course_key": book_course_key,
                "book_user_name": book_user_name,
                "book_user_email": book_user_email,
            },
            dataType: "json",
            success: function (check_results) {
                if (check_results.results == "group course can book" || check_results.results == "you need to pay!") {
                    payEvent(book_course_key, book_value);
                }
                else {
                    alert(check_results.results);
                }
            },
            error: function (xhr, s, error) {
                alert(xhr.status);
                alert(xhr.readyState);
                alert(xhr.responseText);
                alert(xhr.statusText);
            },
        });
    }

    function Delete_Course(book_course_key) {
        alert("The following course you want to delete:");
        alert(book_course_key);

        $.ajax({
            type: "POST",
            url: ca_process_url,
            data: {
                "type": "delete_course",
                "delete_course_key": book_course_key,
            },
            dataType: "json",
            success: function (results) {
                alert("delete successfully!");
                window.location.reload();
            },
            error: function (xhr, s, error) {
                alert(xhr.status);
                alert(xhr.readyState);
                alert(xhr.responseText);
                alert(xhr.statusText);
            },
        });
    }

    // Format method
    function formatDate(format_date) {
        let month = (1 + format_date.getMonth()).toString().padStart(2, '0');
        let day = format_date.getDate().toString().padStart(2, '0');

        return month + '/' + day;
    }

    // Checkbox init
    function checkbox_init(names) {
        var container = document.getElementById("checkbox_container");
        while (container.lastElementChild) {
            container.removeChild(container.lastElementChild);
        }

        // Add checkboxs
        for (var i=0; i<names.length; ++i) {
            // Checkbox
            var checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.name = "teacher_checkbox";
            checkbox.value = names[i];
            checkbox.id = i;
            checkbox.checked = true;
            checkbox.onclick = function() {
                remove_all_display_booking_data();
                setWeekDate(0);
            };
        
            // Label
            var label = document.createElement("label");
            label.htmlFor = i;
            var text = document.createTextNode(names[i]);
            label.appendChild(text);
            label.style.color = teacher_open_course_colors[i];

            
            // <br> element
            var br = document.createElement("br");
            
            // Append
            container.appendChild(checkbox);
            container.appendChild(label);
            container.appendChild(br);
        }
    }

    // Convert UTC
    function convertBookingDataUTC(booking_data) {
        for (let i=0; i<booking_data.length; ++i) {
            var _date = booking_data[i]["date"];
            var _st = booking_data[i]["start_time"];
            var _et = booking_data[i]["end_time"];
            
            var _start_time = new Date(_date);
            _start_time.setHours(parseInt(_st.split(":")[0], parseInt(_st.split(":")[1]), 0));
                
            var _end_time = new Date(_date);
            _end_time.setHours(parseInt(_et.split(":")[0], parseInt(_et.split(":")[1]), 0));

            // Current UTC
            var selected_utc = document.getElementById("UTC_Timezone").value;
            var utc_offset = parseInt(selected_utc.split("UTC")[1]);

            // Convert
            _start_time.setTime(_start_time.getTime() + utc_offset * 1000 * 60 * 60);
            _end_time.setTime(_end_time.getTime() + utc_offset * 1000 * 60 * 60);

            // Save
            // Date
            var y = _start_time.getFullYear().toString();
            var m = _start_time.getMonth() + 1;
            if (m < 10) m = "0" + m.toString();
            else m = m.toString();
            var d = _start_time.getDate();
            if (d < 10) d = "0" + d.toString();
            var _date = y + "-" + m + "-" + d;

            // Time
            var _st = _start_time.getHours().toString() + ":" + _start_time.getMinutes().toString();
            var _et = _end_time.getHours().toString() + ":" + _end_time.getMinutes().toString();

            booking_data[i]["date"] = _date;
            booking_data[i]["start_time"] = _st;
            booking_data[i]["end_time"] = _et;
        }

        return booking_data;
    }

    // Convert UTC from current to new
    function utcChangeEvent() {
        remove_all_display_booking_data();
        var selected_utc = document.getElementById("UTC_Timezone").value;
        var new_utc = parseInt(selected_utc.split("UTC")[1]);
        var old_utc = parseInt(current_utc.split("UTC")[1]);
        var utc_offset = new_utc - old_utc;

        // Update
        current_utc = selected_utc;
        
        for (let i=0; i<booking_data_1on1.length; ++i) {
            var _date = booking_data_1on1[i]["date"];
            var _st = booking_data_1on1[i]["start_time"];
            var _et = booking_data_1on1[i]["end_time"];
            
            var _start_time = new Date(_date);
            _start_time.setHours(parseInt(_st.split(":")[0], parseInt(_st.split(":")[1]), 0));
                
            var _end_time = new Date(_date);
            _end_time.setHours(parseInt(_et.split(":")[0], parseInt(_et.split(":")[1]), 0));
            
            // Convert
            _start_time.setTime(_start_time.getTime() + utc_offset * 1000 * 60 * 60);
            _end_time.setTime(_end_time.getTime() + utc_offset * 1000 * 60 * 60);

            // Save
            // Date
            var y = _start_time.getFullYear().toString();
            var m = _start_time.getMonth() + 1;
            if (m < 10) m = "0" + m.toString();
            else m = m.toString();
            var d = _start_time.getDate();
            if (d < 10) d = "0" + d.toString();
            var _date = y + "-" + m + "-" + d;

            // Time
            var _st = _start_time.getHours().toString() + ":" + _start_time.getMinutes().toString();
            var _et = _end_time.getHours().toString() + ":" + _end_time.getMinutes().toString();

            booking_data_1on1[i]["date"] = _date;
            booking_data_1on1[i]["start_time"] = _st;
            booking_data_1on1[i]["end_time"] = _et;
        }

        for (let i=0; i<booking_data_group.length; ++i) {
            var _date = booking_data_group[i]["date"];
            var _st = booking_data_group[i]["start_time"];
            var _et = booking_data_group[i]["end_time"];
            
            var _start_time = new Date(_date);
            _start_time.setHours(parseInt(_st.split(":")[0], parseInt(_st.split(":")[1]), 0));
                
            var _end_time = new Date(_date);
            _end_time.setHours(parseInt(_et.split(":")[0], parseInt(_et.split(":")[1]), 0));
            
            // Convert
            _start_time.setTime(_start_time.getTime() + utc_offset * 1000 * 60 * 60);
            _end_time.setTime(_end_time.getTime() + utc_offset * 1000 * 60 * 60);

            // Save
            // Date
            var y = _start_time.getFullYear().toString();
            var m = _start_time.getMonth() + 1;
            if (m < 10) m = "0" + m.toString();
            else m = m.toString();
            var d = _start_time.getDate();
            if (d < 10) d = "0" + d.toString();
            var _date = y + "-" + m + "-" + d;

            // Time
            var _st = _start_time.getHours().toString() + ":" + _start_time.getMinutes().toString();
            var _et = _end_time.getHours().toString() + ":" + _end_time.getMinutes().toString();

            booking_data_group[i]["date"] = _date;
            booking_data_group[i]["start_time"] = _st;
            booking_data_group[i]["end_time"] = _et;
        }

        setWeekDate(0);
    }


    // Set date
    function setWeekDate(direction) {
        if (table_mode == 1) booking_data = booking_data_1on1;
        else if (table_mode == 2) booking_data = booking_data_group;

        // Direction
        if (direction == -1) {
            _date.setDate(_date.getDate()-14);
        }
        if (direction == 0) {
            _date.setDate(_date.getDate()-7);
        }

        // Months and Years
        const months = [];
        const years = [];

        // Current weekday
        months[0] = _date.getMonth();
        years[0] = _date.getFullYear();
        
        let weekday_ids = [
            'current_mon',
            'current_tue',
            'current_wed',
            'current_thu',
            'current_fri',
            'current_sat',
            'current_sun'
        ];

        // Filter
        var checkboxs = Array.from(document.getElementsByName("teacher_checkbox"));
        var unchecked_teachers = [];
        checkboxs.forEach( function(v){
            if (v.checked == false) {
                unchecked_teachers.push(v.value);
            }
        });

        for (let i=0; i<7; ++i) {
            document.getElementById(weekday_ids[i]).innerHTML = formatDate(_date);
            _date.setDate(_date.getDate()+1);

            if (months[0] != _date.getMonth()) months[1] = _date.getMonth();
            if (years[0] != _date.getFullYear()) years[1] = _date.getFullYear();

            // Display Course info
            var y = _date.getFullYear();
            var m = _date.getMonth() + 1;
            if (m < 10) m = "0" + m.toString();
            else m = m.toString();
            var d = _date.getDate();
            if (d < 10) d = "0" + d.toString();
            else d = d.toString();
            cur_date = y + "-" + m + "-" + d;

            // Button template
            var button_num = 0;
            var td_container = document.getElementById(weekday_ids[i]+"_container");

            for (var j=0; j<booking_data.length; ++j) {
                if (unchecked_teachers.includes(booking_data[j]["teacher_name"])) continue;
                
                var t = 0;
                for (t=0; t<teacher_names.length; ++t) {
                    if (teacher_names[t] == booking_data[j]["teacher_name"]) break;
                }

                if (cur_date == booking_data[j]["date"]) {
                    var st_h = booking_data[j]["start_time"].split(":")[0];
                    var st_m = booking_data[j]["start_time"].split(":")[1];
                    var et_h = booking_data[j]["end_time"].split(":")[0];
                    var et_m = booking_data[j]["end_time"].split(":")[1];
                    
                    if (parseInt(st_h) < 10) st_h = "0" + st_h;
                    if (parseInt(st_m) < 10) st_m = "0" + st_m;
                    if (parseInt(et_h) < 10) et_h = "0" + et_h;
                    if (parseInt(et_m) < 10) et_m = "0" + et_m;

                    var book_button = document.createElement("input");
                    book_button.type = "button";
                    book_button.value = st_h + ":" + st_m + "-" + et_h + ":" + et_m + "\n$" + booking_data[j]["price"] + " USD";
                    
                    if (table_mode == 1) {
                        if (booking_data[j]["status"] == "booked") {
                            book_button.value += "\n(booked)";
                        }
                        else if (booking_data[j]["status"] == "booking") {
                            book_button.value += "\n(waiting for payment...)";
                        }
                    }
                    else if (table_mode == 2) {
                        var student_num = booking_data[j]["student_names"].length.toString();
                        var max_student_num = booking_data[j]["student_max_num"];
                        book_button.value += "\b(" + student_num + "/" + max_student_num + ")";
                    }
                    
                    // Attribute "name" is store the key and data index
                    // ------------------------------------------------
                    book_button.name = j.toString();
                    // ------------------------------------------------

                    book_button.onclick = bookButtonEvent;

                    // Button colors
                    book_button.style.backgroundColor = teacher_open_course_colors[t];

                    td_container.appendChild(book_button);
                    ++button_num;
                }
            }
            
            // TODO: if button_num == 0 set a message
        }

        // Current Month and Year
        if (months.length == 2 && years.length == 2) {
            document.getElementById('current_month').innerHTML = _months[months[0]] + ' ' + years[0] + ' - ' + _months[months[1]] + years[1];
        }
        else if (months.length == 2) {
            document.getElementById('current_month').innerHTML = _months[months[0]] + ' ' + years[0] + ' - ' + _months[months[1]] + years[0];         
        }
        else {
            document.getElementById('current_month').innerHTML = _months[_date.getMonth()] + ' ' + _date.getFullYear();
        }
    }

    // UTC timezone select
    function autoSelectLocalUTC(n) {
        var n = n + 12;
        document.getElementById('UTC_Timezone').selectedIndex = n;
    }

    // Move display week event
    function nextDateEvent() {
        remove_all_display_booking_data();
        setWeekDate(1);
    }

    function prevDateEvent() {
        remove_all_display_booking_data();
        setWeekDate(-1);
    }

    function goBackTodayEvent() {
        remove_all_display_booking_data();
        _date = new Date();
        _date.setDate(_date.getDate()-_date.getDay()+1);
        setWeekDate(1);
    }

    function remove_all_display_booking_data() {
        let weekday_ids = [
            'current_mon',
            'current_tue',
            'current_wed',
            'current_thu',
            'current_fri',
            'current_sat',
            'current_sun'
        ];

        for (let i=0; i<7; ++i) {
            var td_container = document.getElementById(weekday_ids[i]+"_container");
            while (td_container.lastElementChild) {
                td_container.removeChild(td_container.lastElementChild);
            }
        }
    }


    // Calendar widget
    $(function() {
        $( "#datepicker" ).datepicker({
            dateFormat: "yy-mm-dd",
        });

        $(".timepicker").timepicker({
            "timeFormat": "H:mm"
        });
    });

    // Determine a text is a number or not
    function isNumber(inputData) {
        return parseFloat(inputData).toString() != "NaN";
    }

    // Add new course
    function add_new_course() {
        // Instance
        var datepicker_object = document.getElementById("datepicker");
        var course_start_time_object = document.getElementById("course_start_time");
        var course_end_time_object = document.getElementById("course_end_time");
        var course_price_object = document.getElementById("course_price");
        var course_student_max_num_object = document.getElementById("student_max_num");

        // Check
        if (datepicker_object.value == "") {
            alert("The date field cannot be empty!");
        }
        else if (course_start_time_object.value == "") {
            alert("The start time field cannot be empty!");
        }
        else if (course_end_time_object.value == "") {
            alert("The end time field cannot be empty!");
        }
        else if (course_price_object.value == "") {
            alert("The price field cannot be empty!");
        }
        else if (table_mode == 1 && course_student_max_num_object.value == "") {
            alert("The student max number cannot be empty!");
        }
        else if (isNumber(course_price_object.value) == false) {
            alert("The price must be a number!");
        }
        else {
            var start_time = course_start_time_object.value;
            var end_time = course_end_time_object.value;
            var start_hour = parseInt(start_time.split(":")[0]);
            var start_min = parseInt(start_time.split(":")[1]);
            var end_hour = parseInt(end_time.split(":")[0]);
            var end_min = parseInt(end_time.split(":")[1]);

            // Re-declare start_time and end_time
            var start_time = new Date(datepicker_object.value);
            var end_time = new Date(datepicker_object.value);
            start_time.setHours(start_hour, start_min, 0);
            end_time.setHours(end_hour, end_min, 0);

            // Max student number
            var student_max_num = 0;
            if (table_mode == 2) {
                student_max_num = course_student_max_num_object.value;
            }

            // Check
            if (start_time < end_time) {
                if (table_mode == 1) {
                    Add_New_Course_1on1(
                        document.getElementById("tname").value,
                        datepicker_object.value,
                        start_time,
                        end_time,
                        course_price_object.value,
                    );
                }
                else if (table_mode == 2) {
                    Add_New_Course_Group(
                        document.getElementById("tname").value,
                        datepicker_object.value,
                        start_time,
                        end_time,
                        student_max_num,
                        course_price_object.value,
                    );
                }

                var successed_message = "The course " + datepicker_object.value + " " + course_start_time_object.value + "-" + course_end_time_object.value + " ($" + course_price_object.value + " USD) is add to the booking system!";
                alert(successed_message);
                datepicker_object.value = "";
                course_start_time_object.value = "";
                course_end_time_object.value = "";
                course_price_object.value = "";
                window.location.reload();
            }
            else {
                alert("結束時間不可以設定得比開始時間早！");
            }    
        }
    }

    // Book button event
    function bookButtonEvent() {
        alert(document.getElementById("user_name_field").innerHTML.split(" ")[1]);
        alert(booking_data[parseInt(this.name)]["teacher_name"]);
        alert("Enter bookButtonEvent!");

        if (table_mode == 1) {
            booking_data = booking_data_1on1;
            booking_keys = booking_keys_1on1;
        }
        else if (table_mode == 2) {
            booking_data = booking_data_group;
            booking_keys = booking_keys_group;
        }
        
        var ca_booking_name = booking_keys[parseInt(this.name)];
        var ca_booking_value = booking_data[parseInt(this.name)]["price"];

        alert(ca_booking_name);
        alert(ca_booking_value);




        // If the current visitor has not login
        if (document.getElementById("user_name_field").innerHTML == "Username: false") {
            alert("you must be logged in for booking.");
            location.replace("https://allthing-can.com/login/");
        }

        // If the current user is the course teacher
        else if (document.getElementById("user_name_field").innerHTML.split(" ")[1] == booking_data[parseInt(this.name)]["teacher_name"]) {
            if (window.confirm("Do you want to delete the course?") == true) {
                Delete_Course(ca_booking_name);
            }
        }

        else {
            if (window.confirm("Do you want to book?") == true) {
                alert("YES!");
                
                var book_user_name = document.getElementById("user_name_field").innerHTML.split(" ")[1];
                var book_user_email = document.getElementById("user_email_field").innerHTML.split(" ")[1];
        
                if (table_mode == 1) {
                    Before_Booking_Check_1on1(ca_booking_name, ca_booking_value, book_user_name, book_user_email);
                }
                else if (table_mode == 2) {
                    Before_Booking_Check_Group(ca_booking_name, ca_booking_value, book_user_name, book_user_email);
                }
            } 
            else {
                alert("CANCEL!");
            }
        }
    }

    function payEvent(ca_booking_name, ca_booking_value) {
        // PayPal button
        document.getElementById("ca_booking_name").value = ca_booking_name;
        document.getElementById("ca_booking_value").value = ca_booking_value;

        // Show or Hide
        var div = document.getElementById("background-pop");
        var close = document.getElementById("close-button");

        // User info
        var book_user_name = document.getElementById("user_name_field").innerHTML.split(" ")[1];
        var book_user_email = document.getElementById("user_email_field").innerHTML.split(" ")[1];
        document.getElementById("pay_user_name").value = book_user_name;
        document.getElementById("ca_booking_username").value = book_user_name;
        document.getElementById("pay_user_email").value = book_user_email;

        div.style.display = "block";

        close.onclick = function close() {
            div.style.display = "none";
        }

        window.onclick = function close(e) {
            if (e.target == div) {
                div.style.display = "none";
            }
        }

        // Book event
        book(ca_book_name, book_user_name, book_user_email);
    }

    // Change the course type (1on1 or Group)
    function changeTableMode(mode) {
        table_mode = mode;

        var button_1on1 = document.getElementById("button_1on1");
        var button_group = document.getElementById("button_group");
        var button_history = document.getElementById("button_history");
        const button_list = [button_1on1, button_group, button_history];

        button_list.forEach(removeAllButtonClass);

        function removeAllButtonClass(button) {
            if (button.classList.contains("selected_button")) {
                button.classList.remove("selected_button");
            }
        }

        var course_info_fields = document.getElementById("course_info_fields");
        var book_info_fields = document.getElementById("student_book_history_info");
        var teacher_open_fields = document.getElementById("teacher_open_history_info");

        if (mode == 1) {
            button_1on1.classList.add("selected_button");
            course_info_fields.style.display = "block";
            book_info_fields.style.display = "none";
            teacher_open_fields.style.display = "none";
            remove_all_display_booking_data();
            setWeekDate(1);
        }
        else if (mode == 2) {
            button_group.classList.add("selected_button");
            course_info_fields.style.display = "block";
            book_info_fields.style.display = "none";
            teacher_open_fields.style.display = "none";
            remove_all_display_booking_data();
            setWeekDate(1);
        }
        else if (mode == 3) {
            button_history.classList.add("selected_button");
            course_info_fields.style.display = "none";
            book_info_fields.style.display = "block";
            teacher_open_fields.style.display = "block";
        }
    }

    function bookHistoryMode(mode) {
        // Change button color
        var student_book_history_button_1on1 = document.getElementById("student_book_histroy_button_1on1");
        var student_book_histroy_button_group = document.getElementById("student_book_histroy_button_group");

        const button_list = [student_book_history_button_1on1, student_book_histroy_button_group];
        button_list.forEach(removeAllButtonClass);

        function removeAllButtonClass(button) {
            if (button.classList.contains("selected_button")) {
                button.classList.remove("selected_button");
            }
        }

        // Clear table
        var table_container = document.getElementById("student_book_history_table");
        while (table_container.rows.length > 1) table_container.deleteRow(1);

        if (mode == 1) student_book_histroy_button_1on1.classList.add("selected_button");
        else if (mode == 2) student_book_histroy_button_group.classList.add("selected_button");

        function setBookHistoryTable(data) {
            let new_row = table_container.insertRow(-1);
            let course_cell = new_row.insertCell(0);
            let time_cell = new_row.insertCell(1);
            let teacher_cell = new_row.insertCell(2);

            let course_name = document.createTextNode(data[0]);
            let course_time = document.createTextNode(data[1]);
            let course_teacher = document.createTextNode(data[2]);

            course_cell.appendChild(course_name);
            time_cell.appendChild(course_time);
            teacher_cell.appendChild(course_teacher);
        }

        var current_username = document.getElementById("user_name_field").innerHTML.split(" ")[1];
        var current_user_1on1_book_data = [];
        var current_user_group_book_data = [];

        for (var i=0; i<booking_data_1on1.length; ++i) {
            if (booking_data_1on1[i]["student_name"] == current_username) {
                current_user_1on1_book_data.push([
                    booking_keys_1on1[i],
                    booking_data_1on1[i]["start_time"] + "-" + booking_data_1on1[i]["end_time"],
                    booking_data_1on1[i]["teacher_name"]
                ]);
            }
        }

        for (var i=0; i<booking_data_group.length; ++i) {
            if (booking_data_group[i]["student_names"].includes(current_username)) {
                current_user_group_book_data.push([
                    booking_keys_group[i],
                    booking_data_group[i]["start_time"] + "-" + booking_data_group[i]["end_time"],
                    booking_data_group[i]["teacher_name"]
                ]);
            }
        }

        if (mode == 1) current_user_1on1_book_data.forEach(setBookHistoryTable);
        else if (mode == 2) current_user_group_book_data.forEach(setBookHistoryTable);
    }

    function openHistory() {
        var table_container = document.getElementById("teacher_open_history_table");
        var current_username = document.getElementById("user_name_field").innerHTML.split(" ")[1];

        function setBookHistoryTable(data) {
            let new_row = table_container.insertRow(-1);
            let course_cell = new_row.insertCell(0);
            let time_cell = new_row.insertCell(1);
            let student_cell = new_row.insertCell(2);
            let edit_cell = new_row.insertCell(3);

            let course_name = document.createTextNode(data[0]);
            let course_time = document.createTextNode(data[1]);
            let course_students = document.createTextNode(data[2]);

            course_cell.appendChild(course_name);
            time_cell.appendChild(course_time);
            student_cell.appendChild(course_students);
        }

        var current_user_1on1_book_data = [];
        var current_user_group_book_data = [];

        for (var i=0; i<booking_data_1on1.length; ++i) {
            if (booking_data_1on1[i]["teacher_name"] == current_username) {
                var temp_data = [
                    booking_keys_1on1[i],
                    booking_data_1on1[i]["start_time"] + "-" + booking_data_1on1[i]["end_time"],
                ]

                if (booking_data_1on1[i]["student_name"] != "") {
                    temp_data.push("(1/1) "+booking_data_1on1[i]["student_name"]);
                }
                else {
                    temp_data.push("(0/1)");
                }

                current_user_1on1_book_data.push(temp_data);
            }
        }

        for (var i=0; i<booking_data_group.length; ++i) {
            if (booking_data_group[i]["teacher_name"] == current_username) {
                current_user_group_book_data.push([
                    booking_keys_group[i],
                    booking_data_group[i]["start_time"] + "-" + booking_data_group[i]["end_time"],
                    "("+booking_data_group[i]["student_names"].length.toString()+"/"+booking_data_group[i]["student_max_num"]+")"
                ]);
            }
        }

        current_user_group_book_data.forEach(setBookHistoryTable);
        current_user_1on1_book_data.forEach(setBookHistoryTable);
    }

    // Load the script
    window.onload = function() {
        // Init
        Init();
        
        var offset = new Date().getTimezoneOffset();
        document.getElementById("timezone_field").innerHTML = "Location: " + Intl.DateTimeFormat().resolvedOptions().timeZone + " (" + _offset2UTC[offset.toString()] + ")";
        offset = -1 * offset / 60;
        autoSelectLocalUTC(offset);
    }



</script>


</html>
