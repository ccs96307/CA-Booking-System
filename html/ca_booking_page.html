<html lang='en'>
<!--<script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js'></script>--!>
<link rel="stylesheet" href="//code.jquery.com/ui/1.10.4/themes/smoothness/jquery-ui.css">
<script src="//code.jquery.com/jquery-1.9.1.js"></script>
<script src="//code.jquery.com/ui/1.10.4/jquery-ui.js"></script>
<link rel="stylesheet" href="http://jqueryui.com/resources/demos/style.css">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/timepicker/1.3.5/jquery.timepicker.min.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/timepicker/1.3.5/jquery.timepicker.min.js"></script>


<head>
</head>

<style>
table, tr, td {
    border: 1px solid black;
    text-align: center;
}

caption {
    text-align: center;
}
</style>

<body>
    <!-- Personal Info --!>
    <dl>
        <dt id="user_name_field">Username:</dt>
        <dt id="user_role_field">Role:</dt>
        <dt id="timezone_field">Location:</dt>
        <dt id="local_utc_field">UTC: 
            <!-- UTC --!>
            <select id="UTC_Timezone">
                <option>UTC-12</option>
                <option>UTC-11</option>
                <option>UTC-10</option>
                <option>UTC-9</option>
                <option>UTC-8</option>
                <option>UTC-7</option>
                <option>UTC-6</option>
                <option>UTC-5</option>
                <option>UTC-4</option>
                <option>UTC-3</option>
                <option>UTC-2</option>
                <option>UTC-1</option>
                <option>UTC+0</option>
                <option>UTC+1</option>
                <option>UTC+2</option>
                <option>UTC+3</option>
                <option>UTC+4</option>
                <option>UTC+5</option>
                <option>UTC+6</option>
                <option>UTC+7</option>
                <option>UTC+8</option>
                <option>UTC+9</option>
                <option>UTC+10</option>
                <option>UTC+11</option>
                <option>UTC+12</option>
                <option>UTC+13</option>
                <option>UTC+14</option>
            </select>
        </dt>
    </dl>

    <!-- Teacher Checkboxs --!>
    <div id='checkbox_container'>
        <input type='checkbox' id='checkbox_teacher_id_1' name='checkbox_teacher_name_1' onclick='checkbox_event()'>
        <label id='checkbox_label_1' for='checkbox_teacher_name_1'>Clay</label>
    </div>
    
    <!-- Change date button --!>
    <div style='display: flex; justify-content: space-between;'>
        <button onclick='prev()'>PREV</button>
        <button onclick='go_back_to_today()'>Go Back To Today</button>
        <button onclick='next()'>NEXT</button>
    </div>
    
    <!-- Weekly calendar --!>
    <table>
        <caption id='current_month'><h3></h3></caption>
        <tr>
            <td>Mon</td>
            <td>Tue</td>
            <td>Wed</td>
            <td>Thu</td>
            <td>Fri</td>
            <td style='color: red'>Sat</td>
            <td style='color: red'>Sun</td>
        </tr>
        <tr>
            <td id='current_mon'></td>
            <td id='current_tue'></td>
            <td id='current_wed'></td>
            <td id='current_thu'></td>
            <td id='current_fri'></td>
            <td id='current_sat'></td>
            <td id='current_sun'></td>
        </tr>
        <tr>
            <td id="test_td">
            </td>
        </tr>
    </table>

    <!-- Teacher can set the course info --!>
    <div style="display: none" id="teacher_course_settings">
    <dl>
        <dt>
            <p>Teacher:<input type="text" id="tname" name="tname"></p>
        </dt>
        <dt>
            <p>Date:<input type="text" class="datepicker" id="datepicker"></p>
        </dt>
        <dt>
            <p>Start Time:<input type="text" class="timepicker" id="course_start_time"></p>
        </dt>
        <dt>
            <p>End Time:<input type="text" class="timepicker" id="course_end_time"></p>
        </dt>
        <dt>
            <p>Price:<input type="text" id="course_price"></p>
        </dt>
    </dl>
        <button style="float: right;" onclick="add_new_course()">CREATE</button>
    </div>


    My name is <span id='result'></span>.<hr />
    <input id='search_id' />
<button onclick='Search()'>Search</button>

</body>




<script>
    // Settings
    var booking_data;

    const _months = [
        'January',
        'February',
        'March',
        'April',
        'May',
        'June',
        'July',
        'August',
        'September',
        'October',
        'November',
        'December'
    ];

    const _weekdays = [
        'Sunday',
        'Monday',
        'Tuesday',
        'Wednesday',
        'Thrusday',
        'Friday',
        'Saturday',
    ];

    
    const _offset2UTC = {
        "0": "UTC+0",
        "60": "UTC-1",
        "120": "UTC-2",
        "180": "UTC-3",
        "240": "UTC-4",
        "300": "UTC-5",
        "360": "UTC-6",
        "420": "UTC-7",
        "480": "UTC-8",
        "540": "UTC-9",
        "600": "UTC-10",
        "660": "UTC-11",
        "720": "UTC-12",
        "-60": "UTC+1",
        "-120": "UTC+2",
        "-180": "UTC+3",
        "-240": "UTC+4",
        "-300": "UTC+5",
        "-360": "UTC+6",
        "-420": "UTC+7",
        "-480": "UTC+8",
        "-540": "UTC+9",
        "-600": "UTC+10",
        "-660": "UTC+11",
        "-720": "UTC+12",
        "-780": "UTC+13",
        "-840": "UTC+14",
    };

    // AJAX
    function Search() {
        alert(booking_data);

        $.ajax({
            type: 'POST',
            url: '../test.php',
            data: {
                'type': 'search',
                'id': $('#search_id').val(),
                '_mon': $('#current_mon').text(),
                '_tue': $('#current_tue').text()
            },
            dataType: 'json',
            success: function (str) {
                document.getElementById('result').innerHTML = str.name;
            },
            error: function (e) {
                alert(e);
                alert('something error');
            },
            beforeSned: function() {

            }
        });
    }

    function Add_New_Course(tname, _date, start_time, end_time, price) {
        var selected_utc = document.getElementById("UTC_Timezone").value;
        var utc_offset = -1 * parseInt(selected_utc.split("UTC")[1]);
        var start_time_timestamps = start_time.getTime();
        var end_time_timestamps = end_time.getTime();

        start_time.setTime(start_time_timestamps + utc_offset * 1000 * 60 * 60);
        end_time.setTime(end_time_timestamps + utc_offset * 1000 * 60 * 60);
        
        // Time
        var _st = start_time.getHours().toString() + ":" + start_time.getMinutes().toString();
        var _et = end_time.getHours().toString() + ":" + end_time.getMinutes().toString();

        $.ajax({
            type: "POST",
            url: "../test.php",
            data: {
                "type": "add_new_course",
                "teacher_name": tname,
                "date": _date,
                "start_time": _st,
                "end_time": _et,
                "price": price,
            },
            dataType: "json",
            success: function(results) {
                alert(results.message);
            },
            error: function (e) {
                alert(e);
                alert('something error');
            },
            beforeSend: function() {

            }
        });
    }

    function Init() {
        $.ajax({
            type: 'POST',
            url: '../test.php',
            data: {
                'type': 'init',
            },
            dataType: 'json',
            success: function (init_data) {
                document.getElementById('result').innerHTML = init_data.teachers;
                document.getElementById("user_name_field").innerHTML = "Username: " + init_data.current_user_name;
                document.getElementById("user_role_field").innerHTML = "Role: " + init_data.current_user_role;

                checkbox_init(init_data.teachers);

                // If user role is teacher, he/she can add the new course on the booking system
                if (init_data.current_user_role == "um_teacher") {
                    document.getElementById("teacher_course_settings").style.display = 'block';
                    document.getElementById("tname").value = init_data.current_user_name;
                    document.getElementById("tname").disabled = true;
                }

                booking_data = init_data.booking_data;
                convertBookingDataUTC();
                setWeekDate(1);
            },
            error: function (e) {
                alert(e);
                alert('something error');
            },
            beforeSned: function() {

            }
        });
    }

    // Init
    var _date = new Date();
    _date.setDate(_date.getDate()-_date.getDay()+1);

    // Format method
    function formatDate(format_date) {
        let month = (1 + format_date.getMonth()).toString().padStart(2, '0');
        let day = format_date.getDate().toString().padStart(2, '0');

        return month + '/' + day;
    }

    // Checkbox events
    function checkbox_event() {
        var checkbox = document.getElementById('checkbox_teacher_id_1');
        var label = document.getElementById('checkbox_label_1');

        // If checked
        if (checkbox.checked == true) {
            label.innerHTML = 'Atlas';
        }
        else {
            label.innerHTML = 'Clay';
        }
    }

    // Checkbox init
    function checkbox_init(names) {
        // Add checkboxs
        for (var i=0; i<names.length; ++i) {
            // Container
            var container = document.getElementById("checkbox_container");

            // Checkbox
            var checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.name = names[i];
            checkbox.value = i;
            checkbox.id = i;
            checkbox.onclick = function() {
                // TODO
            };
        
            // Label
            var label = document.createElement("label");
            label.htmlFor = i;
            label.appendChild(document.createTextNode(names[i]));
            
            // <br> element
            var br = document.createElement("br");
            
            // Append
            container.appendChild(checkbox);
            container.appendChild(label);
            container.appendChild(br);
        }
    }

    // Convert UTC
    function convertBookingDataUTC() {
        for (let i=0; i<booking_data.length; ++i) {
            var _date = booking_data[i]["date"];
            var _st = booking_data[i]["start_time"];
            var _et = booking_data[i]["end_time"];
            
            var _start_time = new Date(_date);
            _start_time.setHours(parseInt(_st.split(":")[0], parseInt(_st.split(":")[1]), 0));
                
            var _end_time = new Date(_date);
            _end_time.setHours(parseInt(_et.split(":")[0], parseInt(_et.split(":")[1]), 0));

            // Current UTC
            var selected_utc = document.getElementById("UTC_Timezone").value;
            var utc_offset = parseInt(selected_utc.split("UTC")[1]);

            if (_end_time < _start_time) {
                // Add one day
                _end_time.setTime(_end_time.getTime() + 1 * 1000 *  60 * 24);
            }

            // Convert
            _start_time.setTime(_start_time.getTime() + utc_offset * 1000 * 60 * 60);
            _end_time.setTime(_end_time.getTime() + utc_offset * 1000 * 60 * 60);

            // Save
            // Date
            var y = _start_time.getFullYear().toString();
            var m = _start_time.getMonth() + 1;
            if (m < 10) m = "0" + m.toString();
            else m = m.toString();
            var d = _start_time.getDate();
            if (d < 10) d = "0" + d.toString();
            var _date = y + "-" + m + "-" + d;

            // Time
            var _st = _start_time.getHours().toString() + ":" + _start_time.getMinutes().toString();
            var _et = _end_time.getHours().toString() + ":" + _end_time.getMinutes().toString();

            booking_data[i]["date"] = _date;
            booking_data[i]["start_time"] = _st;
            booking_data[i]["end_time"] = _et;
        }
    }

    // Set date
    function setWeekDate(direction) {
        // Direction
        if (direction == -1) {
            _date.setDate(_date.getDate()-14);
        }

        // Months and Years
        const months = [];
        const years = [];

        // Current weekday
        months[0] = _date.getMonth();
        years[0] = _date.getFullYear();
        
        let weekday_ids = [
            'current_mon',
            'current_tue',
            'current_wed',
            'current_thu',
            'current_fri',
            'current_sat',
            'current_sun'
        ];

        for (let i=0; i<7; ++i) {
            document.getElementById(weekday_ids[i]).innerHTML = formatDate(_date);
            _date.setDate(_date.getDate()+1);

            if (months[0] != _date.getMonth()) months[1] = _date.getMonth();
            if (years[0] != _date.getFullYear()) years[1] = _date.getFullYear();

            // Display Course info
            var y = _date.getFullYear();
            var m = _date.getMonth() + 1;
            if (m < 10) m = "0" + m.toString();
            else m = m.toString();
            var d = _date.getDate();
            if (d < 10) d = "0" + d.toString();
            else d = d.toString();
            cur_date = y + "-" + m + "-" + d;

            // Button template
            var td_container = document.getElementById("test_td");
            var book_button = document.createElement("input");
            book_button.type = "button";

            //td_container.appendChild(book_button);

            for (var j=0; j<booking_data.length; ++j) {
                if (cur_date == booking_data[j]["date"]) {
                    td_container.appendChild(book_button);
                }
            }
        }

        // Current Month and Year
        if (months.length == 2 && years.length == 2) {
            document.getElementById('current_month').innerHTML = _months[months[0]] + ' ' + years[0] + ' - ' + _months[months[1]] + years[1];
        }
        else if (months.length == 2) {
            document.getElementById('current_month').innerHTML = _months[months[0]] + ' ' + years[0] + ' - ' + _months[months[1]] + years[0];         
        }
        else {
            document.getElementById('current_month').innerHTML = _months[_date.getMonth()] + ' ' + _date.getFullYear();
        }
    }

    // UTC timezone select
    function autoSelectLocalUTC(n) {
        var n = n + 12;
        document.getElementById('UTC_Timezone').selectedIndex = n;
    }


    // Move display week event
    function next() {
        setWeekDate(1);
        Search();
    }

    function prev() {
        setWeekDate(-1);
        Search();
    }

    function go_back_to_today() {
        _date = new Date();
        _date.setDate(_date.getDate()-_date.getDay()+1);
        setWeekDate(1);
        Search();
    }

    // Calendar widget
    $(function() {
        $( "#datepicker" ).datepicker({
            dateFormat: "yy-mm-dd",
        });

        $(".timepicker").timepicker({
            "timeFormat": "H:mm"
        });
    });

    // Determine a text is a number or not
    function isNumber(inputData) {
        if (parseFloat(inputData).toString() == "NaN") {
            return false;
        }
        else {
            return true;
        }
    }

    // Add new course
    function add_new_course() {
        // Instance
        var datepicker_object = document.getElementById("datepicker");
        var course_start_time_object = document.getElementById("course_start_time");
        var course_end_time_object = document.getElementById("course_end_time");
        var course_price_object = document.getElementById("course_price");

        // Check
        if (datepicker_object.value == "") {
            alert("The date field cannot be empty!");
        }
        else if (course_start_time_object.value == "") {
            alert("The start time field cannot be empty!");
        }
        else if (course_end_time_object.value == "") {
            alert("The end time field cannot be empty!");
        }
        else if (course_price_object.value == "") {
            alert("The price field cannot be empty!");
        }
        else if (isNumber(course_price_object.value) == false) {
            alert("The price must be a number!");
        }
        else {
            var start_time = course_start_time_object.value;
            var end_time = course_end_time_object.value;
            var start_hour = parseInt(start_time.split(":")[0]);
            var start_min = parseInt(start_time.split(":")[1]);
            var end_hour = parseInt(end_time.split(":")[0]);
            var end_min = parseInt(end_time.split(":")[1]);

            // Re-declare start_time and end_time
            var start_time = new Date(datepicker_object.value);
            var end_time = new Date(datepicker_object.value);
            start_time.setHours(start_hour, start_min, 0);
            end_time.setHours(end_hour, end_min, 0);

            // Check
            if (start_time < end_time) {
                Add_New_Course(
                    document.getElementById("tname").value,
                    datepicker_object.value,
                    start_time,
                    end_time,
                    course_price_object.value,
                );
                var successed_message = "The course " + datepicker_object.value + " " + course_start_time_object.value + "-" + course_end_time_object.value + " ($" + course_price_object.value + " USD) is add to the booking system!";
                alert(successed_message);
                datepicker_object.value = "";
                course_start_time_object.value = "";
                course_end_time_object.value = "";
                course_price_object.value = "";
            }
            else {
                alert("結束時間不可以設定得比開始時間早！");
            }    
        }
    }

    // Show the class on the week widget
    function show_course_on_widget() {
        
    }


    // Load the script
    window.onload = function() {
        // Init
        Init();
        
        var offset = new Date().getTimezoneOffset();
        
        document.getElementById("timezone_field").innerHTML = "Location: " + Intl.DateTimeFormat().resolvedOptions().timeZone + " (" + _offset2UTC[offset.toString()] + ")";

        offset = -1 * offset / 60;
        autoSelectLocalUTC(offset);

        // Parsing URL
        let param_url = new URL(location.href);
        let params = param_url.searchParams;
        for (let pair of params.entries()) {
            alert(pair[1]);
        }
    }

</script>


</html>
